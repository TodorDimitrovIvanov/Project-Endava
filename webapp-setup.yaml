---
# Source: https://stackoverflow.com/questions/55472314/how-to-deploy-code-from-local-git-repository-to-remote-server-using-ansible
# Source: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html
# Source: https://blog.knoldus.com/how-to-install-python-in-target-host-using-ansible/
- hosts: azure-app-vms
  connection: local
  become_method: su

  # Source: https://sleeplessbeastie.eu/2020/02/07/how-to-instruct-ansible-to-use-specific-version-of-python/
  vars:
    ansible_python_interpreter: /usr/bin/python3

  vars_prompt:
    - name: app_serv_pass
      prompt: "Enter the Web App server's administrator password"

  tasks:
    - name: Make temp directory
      tempfile:
        state: directory
      register: temp_git_archive
      delegate_to: localhost
      changed_when: False
    
    # Source: https://opensource.com/article/17/8/ansible-environment-management
    # The source above doesn't work because the SSH account is not root but has sudo permissions 
    # Therefore to solve this issue we need to run a command instead 
    - name: Installing git  on the target VM
      command: sudo apt-get install -y git

    - name: Installing pip3 on the target VM
      command: sudo apt-get install -y python3-pip

    - name: Installing setuptools for Python 3
      command: sudo apt-get install -y python3-setuptools

    # Source: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html
    - name: Clone the repo in specified directory 
      ansible.builtin.git:
        repo: https://github.com/TodorDimitrovIvanov/PythonWebApp/
        dest:  /home/todor/web

    # Source: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/pip_module.html
    - name: Install Python requirements using pip
      pip: 
        executable: /usr/bin/pip3
        requirements: /home/todor/web/requirements.txt

    # Source: https://stackoverflow.com/questions/35984151/how-to-create-new-system-service-by-ansible-playbook
    - name: Creating up a service for running the Python web app 
      copy: src=services/webapp dest=/lib/systemd/system/py-webapp.service

    - name: Enabling the service
      service: name=py-webapp enabled=yes 

    - name: Starting the service
      service: name=py-webapp state=started

    # Source: https://stackoverflow.com/questions/35139711/running-python-script-via-ansible
    #- name: Start the Python web app 
    #  command: /usr/bin/python3 /home/todor/web/app.py

